<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€Œè·ã€ç†æ‡·ç–‘æˆ‘å­¸ä¸æœƒ - Kelsey Lo's Lab</title>
    <style>
        :root { --main-purple: #D94DFF; --bg-purple: #f8f5fa; --deep-purple: #4A148C; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; line-height: 1.6; margin: 0; background: var(--bg-purple); color: #333; }
        header { background: var(--main-purple); color: white; padding: 1.5rem; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }
        
        /* å°è¦½åˆ— */
        nav { background: #333; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: center; }
        .nav-links { display: flex; list-style: none; margin: 0; padding: 0; }
        nav a { color: white; padding: 15px 20px; text-decoration: none; font-weight: bold; cursor: pointer; }
        nav a:hover { color: var(--main-purple); }

        .container { max-width: 1000px; margin: 20px auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); min-height: 85vh; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* å¡ç‰‡èˆ‡ç¶²æ ¼ */
        .section-title { border-bottom: 3px solid var(--main-purple); color: var(--deep-purple); padding-bottom: 10px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .content-card { background: white; border: 1px solid #eee; border-radius: 12px; overflow: hidden; transition: 0.3s; border-left: 6px solid var(--main-purple); }
        .content-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
        .card-body { padding: 15px; }

        /* æ¨è–¦å€ï¼ˆç½®é ‚ï¼‰ */
        .top-recommendation { background: #fdf5ff; border: 2px solid var(--main-purple); border-radius: 15px; padding: 20px; margin-bottom: 30px; }

        /* æ¸¬é©—èˆ‡æŒ‰éˆ• */
        .btn { background: var(--main-purple); color: white; border: none; padding: 8px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn:hover { opacity: 0.9; }
        .quiz-btn { font-size: 0.9rem; margin-left: 10px; }

        /* åˆ†é å™¨ */
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 30px; align-items: center; }
        .page-num { padding: 5px 12px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .page-num.active { background: var(--main-purple); color: white; border-color: var(--main-purple); }

        /* å½ˆçª— Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; }

        /* å³éµé¸å–® */
        #context-menu { display: none; position: absolute; background: white; border: 1px solid #ddd; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); border-radius: 8px; z-index: 3000; width: 120px; overflow: hidden; }
        .context-item { padding: 10px 15px; cursor: pointer; font-size: 14px; }
        .context-item:hover { background: var(--bg-purple); color: var(--main-purple); }

        /* å–®å­—å¡ */
        .flashcard { height: 120px; perspective: 1000px; cursor: pointer; position: relative; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; padding: 15px; text-align: center; }
        .flashcard-back { background: var(--main-purple); color: white; transform: rotateY(180deg); flex-direction: column; }
    </style>
</head>
<body>

<header onclick="showPage('home-page')"><h1>ã€Œè·ã€ç†æ‡·ç–‘æˆ‘å­¸ä¸æœƒ</h1></header>

<nav>
    <div class="nav-links">
        <a onclick="showPage('home-page')">ğŸ  é¦–é </a>
        <a onclick="showPage('news')">ğŸ“° æ–°è</a>
        <a onclick="showPage('video')">ğŸ“º å½±ç‰‡</a>
        <a onclick="showPage('podcast')">ğŸ§ Podcast</a>
        <a onclick="showPage('grammar')">ğŸ“š æ–‡æ³•</a>
        <a onclick="showPage('common-vocab')">ğŸ’¡ 500å–®</a>
        <a onclick="showPage('vocab')">ğŸ”¥ å–®å­—åº«</a>
    </div>
</nav>

<div class="container">
    <section id="home-page" class="page active-page">
        <h2 class="section-title">Welkom! ä»Šæ—¥é©šå–œå…§å®¹</h2>
        <div id="home-recommendation" class="dashboard-grid"></div>
        <hr style="margin: 40px 0; border: 0; border-top: 1px solid #eee;">
        <h2 class="section-title">å¿«é€Ÿå‰å¾€åŠŸèƒ½</h2>
        <div class="dashboard-grid">
            <div class="content-card card-body" onclick="showPage('news')" style="text-align:center; padding:30px; cursor:pointer;"><h3>ğŸ“° ä»Šæ—¥æ–°è</h3></div>
            <div class="content-card card-body" onclick="showPage('video')" style="text-align:center; padding:30px; cursor:pointer;"><h3>ğŸ“º ç²¾é¸å½±ç‰‡</h3></div>
            <div class="content-card card-body" onclick="showPage('podcast')" style="text-align:center; padding:30px; cursor:pointer;"><h3>ğŸ§ Podcast</h3></div>
        </div>
    </section>

    <section id="news" class="page">
        <div class="top-recommendation" id="news-today"></div>
        <h2 class="section-title">éå»æ–°èå›é¡§</h2>
        <div id="news-list" class="dashboard-grid"></div>
        <div class="pagination" id="news-pagination"></div>
    </section>

    <section id="video" class="page">
        <div class="top-recommendation" id="video-today"></div>
        <h2 class="section-title">æ‰€æœ‰å½±ç‰‡åˆ—è¡¨</h2>
        <div id="video-list" class="dashboard-grid"></div>
        <div class="pagination" id="video-pagination"></div>
    </section>

    <section id="podcast" class="page">
        <div id="podcast-filters" style="margin-bottom:20px;"></div>
        <div class="top-recommendation" id="podcast-today"></div>
        <h2 class="section-title">Podcast åˆ—è¡¨</h2>
        <div id="podcast-list" class="dashboard-grid"></div>
        <div class="pagination" id="podcast-pagination"></div>
    </section>

    <section id="common-vocab" class="page">
        <h2 class="section-title">å¸¸ç”¨ 500 å–®å­— <button class="btn quiz-btn" onclick="openQuizSetup('common')">ğŸ“ é–‹å§‹æ¸¬é©—</button></h2>
        <div id="common-vocab-list" class="dashboard-grid" style="grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));"></div>
    </section>

    <section id="vocab" class="page">
        <h2 class="section-title">æˆ‘çš„å–®å­—åº« <button class="btn quiz-btn" onclick="openQuizSetup('personal')">ğŸ“ é–‹å§‹æ¸¬é©—</button></h2>
        <p><small>ğŸ’¡ åœ¨å¡ç‰‡ä¸Šé»æ“Šå³éµå¯ç·¨è¼¯æˆ–åˆªé™¤</small></p>
        <div id="my-vocab-list" class="dashboard-grid" style="grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));"></div>
    </section>
    
    <section id="grammar" class="page">
        <h2 class="section-title">ğŸ“š æ–‡æ³•åŸºç¤æ•™å­¸</h2>
        <div id="grammar-list-area" class="dashboard-grid"></div>
    </section>
</div>

<div id="quiz-setup-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('quiz-setup-modal')">&times;</span>
        <h3 id="quiz-title">æ¸¬é©—è¨­å®š</h3>
        <label>ç¯„åœï¼š<input type="number" id="quiz-start" value="1" style="width:50px"> ~ <input type="number" id="quiz-end" value="20" style="width:50px"></label><br><br>
        <label>é¡Œå‹ (å¤šé¸)ï¼š</label><br>
        <input type="checkbox" name="qType" value="fill" checked> å¡«å……é¡Œ (æ‹¼å¯«/å«ç¾©)<br>
        <input type="checkbox" name="qType" value="mcq" checked> å–®é¸é¡Œ (å››é¸ä¸€)<br><br>
        <button class="btn" onclick="startQuiz()">ç¢ºèªé–‹å§‹</button>
    </div>
</div>

<div id="quiz-play-modal" class="modal">
    <div class="modal-content" id="quiz-play-body"></div>
</div>

<div id="edit-vocab-modal" class="modal">
    <div class="modal-content">
        <h3>ç·¨è¼¯å–®å­—</h3>
        è·èªï¼š<input type="text" id="edit-nl" style="width:100%"><br><br>
        ä¸­æ–‡ï¼š<input type="text" id="edit-zh" style="width:100%"><br><br>
        è¨»è§£ï¼š<textarea id="edit-note" style="width:100%"></textarea><br><br>
        <button class="btn" onclick="saveVocabEdit()">å„²å­˜</button>
        <button class="btn" style="background:#666" onclick="closeModal('edit-vocab-modal')">å–æ¶ˆ</button>
    </div>
</div>

<div id="context-menu">
    <div class="context-item" onclick="triggerEdit()">âœï¸ ç·¨è¼¯åŠŸèƒ½</div>
    <div class="context-item" onclick="triggerDelete()" style="color:red">ğŸ—‘ï¸ åˆªé™¤å–®å­—</div>
</div>



<script>
// --- æ ¸å¿ƒè®Šæ•¸ ---
let state = {
    news: [], video: [], podcast: [], commonVocab: [], personalVocab: [],
    currentPage: { news: 1, video: 1, podcast: 1 },
    quizData: [], quizCurrentIdx: 0, quizScore: 0,
    editingIdx: -1, contextIdx: -1
};

// --- åˆå§‹åŒ–è¼‰å…¥ ---
window.onload = async () => {
    await Promise.all([loadNews(), loadVideos(), loadPodcasts(), loadCommon500(), loadPersonalVocab(), loadGrammar()]);
    renderHome();
};

function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
    document.getElementById(id).classList.add('active-page');
    window.scrollTo(0, 0);
    renderAll();
}

// --- è³‡æ–™è®€å– ---
async function loadNews() {
    try { const res = await fetch('data/news.json'); state.news = await res.json(); } catch(e){ console.log("æ–°èè¼‰å…¥å¤±æ•—"); }
}

async function loadVideos() {
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR8wPI8N4w0wlhmpmkpocU5EiYc9d3taHZKwCyZLhNgbqX1llerSDiK4Ic8V_pwkBzieJwOPRwDEjNT/pub?output=csv";
    const res = await fetch(url); const text = await res.text();
    state.video = text.split('\n').slice(1).map(r => {
        const c = r.split(',');
        return { url: c[0], title: c[1], nl: c[2], zh: c[3], img: getYTImg(c[0]) };
    });
}

function getYTImg(url) {
    let id = url.includes("v=") ? url.split("v=")[1].split("&")[0] : url.split("be/")[1];
    return `https://img.youtube.com/vi/${id}/mqdefault.jpg`;
}

async function loadPodcasts() {
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSd7GEHtv2OBGwouVB5_YMEVI8kuMxjhiOCVd5VeFjoFDvRpy1ae-h9_dXOPIJQ0d2Z0vWw47dhay0g/pub?output=csv";
    const res = await fetch(url); const text = await res.text();
    state.podcast = text.split('\n').slice(1).map(r => {
        const c = r.split(',');
        return { title: c[0], link: c[1], desc: c[2], cat: c[3]?.trim() || "ç²¾é¸", img: c[4]?.trim() || "https://images.unsplash.com/photo-1478737270239-2fccd2c7862a?q=80&w=300" };
    });
}

async function loadCommon500() {
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSIvZ0IY5T_OQ34OMEC55MY5DlJZxMGnref44KQ0U64BxADFtLmkP_y9Toq2YxK0xhNE33qJ2uQoBOX/pub?output=csv";
    const res = await fetch(url); const text = await res.text();
    state.commonVocab = text.split('\n').slice(1).map(r => { const c = r.split(','); return {nl: c[0], zh: c[1]}; });
}

function loadPersonalVocab() {
    state.personalVocab = JSON.parse(localStorage.getItem('myVocab') || '[]');
}

async function loadGrammar() {
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSm8LXFgsWwIx-C2HjngRtz_do9bkNB_BJwR82EV17Gfeht6wDcvmprJan9FlEhi5X9wwrCNV6Vkzft/pub?output=csv";
    const res = await fetch(url); const text = await res.text();
    const rows = text.split('\n').slice(1);
    document.getElementById('grammar-list-area').innerHTML = rows.map(r => {
        const [u, t, l] = r.split(',');
        return u ? `<div class="content-card card-body" onclick="window.open('${l}')"><h3>Unit ${u}: ${t}</h3></div>` : '';
    }).join('');
}

// --- æ¸²æŸ“é‚è¼¯ ---
function renderAll() {
    renderPaginationList('news', state.news, 20);
    renderPaginationList('video', state.video, 20);
    renderPaginationList('podcast', state.podcast, 20);
    renderVocab('common-vocab-list', state.commonVocab);
    renderVocab('my-vocab-list', state.personalVocab, true);
}

function renderHome() {
    const home = document.getElementById('home-recommendation');
    home.innerHTML = '';
    const recs = [
        {type: 'æ–°è', d: state.news[0], target: 'news'},
        {type: 'å½±ç‰‡', d: state.video[0], target: 'video'},
        {type: 'Podcast', d: state.podcast[0], target: 'podcast'}
    ];
    recs.forEach(r => {
        if(!r.d) return;
        home.innerHTML += `
            <div class="content-card" onclick="showPage('${r.target}')">
                <img src="${r.d.img || 'https://via.placeholder.com/300'}" class="card-img">
                <div class="card-body"><span class="btn" style="padding:2px 8px; font-size:10px">${r.type}</span><h3>${r.d.title}</h3></div>
            </div>`;
    });
}

function renderPaginationList(type, data, perPage) {
    const p = state.currentPage[type];
    const todayArea = document.getElementById(`${type}-today`);
    const listArea = document.getElementById(`${type}-list`);
    const paginArea = document.getElementById(`${type}-pagination`);

    // 1. ç½®é ‚æ¨è–¦
    if(data[0]) {
        todayArea.innerHTML = `<h3>ğŸŒŸ ä»Šæ—¥æ¨è–¦</h3><div style="display:flex; gap:20px; align-items:center;">
            <img src="${data[0].img || ''}" style="width:200px; border-radius:10px;">
            <div><h3>${data[0].title}</h3><button class="btn" onclick="openItem('${type}', 0)">ç«‹å³æŸ¥çœ‹</button></div>
        </div>`;
    }

    // 2. åˆ—è¡¨åˆ†é 
    const start = (p-1) * perPage;
    const pagedData = data.slice(start, start + perPage);
    listArea.innerHTML = pagedData.map((d, i) => `
        <div class="content-card" onclick="openItem('${type}', ${start + i})">
            <img src="${d.img || ''}" class="card-img">
            <div class="card-body"><h4>${d.title}</h4></div>
        </div>`).join('');

    // 3. é ç¢¼
    const totalPages = Math.ceil(data.length / perPage);
    paginArea.innerHTML = `ç¬¬ ${p} é  / å…± ${totalPages} é  `;
    for(let i=1; i<=totalPages; i++) {
        paginArea.innerHTML += `<span class="page-num ${i===p?'active':''}" onclick="changePage('${type}', ${i})">${i}</span>`;
    }
}

function changePage(type, page) { state.currentPage[type] = page; renderAll(); }

function renderVocab(id, list, isPersonal=false) {
    const area = document.getElementById(id);
    area.innerHTML = list.map((v, i) => `
        <div class="flashcard" onclick="this.classList.toggle('flipped')" oncontextmenu="showContext(event, ${i}, ${isPersonal})">
            <div class="flashcard-inner">
                <div class="flashcard-front">${v.nl}</div>
                <div class="flashcard-back">${v.zh}</div>
            </div>
        </div>`).join('');
}

// --- å³éµé¸å–®èˆ‡ç®¡ç† ---
function showContext(e, idx, isPersonal) {
    if(!isPersonal) return;
    e.preventDefault();
    state.contextIdx = idx;
    const menu = document.getElementById('context-menu');
    menu.style.display = 'block';
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
}

document.addEventListener('click', () => document.getElementById('context-menu').style.display = 'none');

function triggerEdit() {
    const v = state.personalVocab[state.contextIdx];
    state.editingIdx = state.contextIdx;
    document.getElementById('edit-nl').value = v.nl;
    document.getElementById('edit-zh').value = v.zh;
    document.getElementById('edit-note').value = v.note || '';
    document.getElementById('edit-vocab-modal').style.display = 'flex';
}

function saveVocabEdit() {
    const idx = state.editingIdx;
    state.personalVocab[idx] = {
        nl: document.getElementById('edit-nl').value,
        zh: document.getElementById('edit-zh').value,
        note: document.getElementById('edit-note').value
    };
    localStorage.setItem('myVocab', JSON.stringify(state.personalVocab));
    closeModal('edit-vocab-modal');
    renderVocab('my-vocab-list', state.personalVocab, true);
}

function triggerDelete() {
    if(confirm('ç¢ºå®šåˆªé™¤é€™å€‹å–®å­—å—ï¼Ÿ')) {
        state.personalVocab.splice(state.contextIdx, 1);
        localStorage.setItem('myVocab', JSON.stringify(state.personalVocab));
        renderVocab('my-vocab-list', state.personalVocab, true);
    }
}

// --- æ¸¬é©—ç³»çµ± ---
let quizType = 'common';
function openQuizSetup(type) {
    quizType = type;
    document.getElementById('quiz-title').innerText = type === 'common' ? '500å–®å­—æ¸¬é©—è¨­å®š' : 'æˆ‘çš„å–®å­—åº«æ¸¬é©—è¨­å®š';
    document.getElementById('quiz-setup-modal').style.display = 'flex';
}

function startQuiz() {
    const start = parseInt(document.getElementById('quiz-start').value) - 1;
    const end = parseInt(document.getElementById('quiz-end').value);
    const source = quizType === 'common' ? state.commonVocab : state.personalVocab;
    const rangeData = source.slice(start, end);
    
    if(rangeData.length < 1) return alert('ç¯„åœå…§æ²’æœ‰å–®å­—ï¼');
    
    state.quizData = rangeData.sort(() => Math.random() - 0.5);
    state.quizCurrentIdx = 0;
    state.quizScore = 0;
    
    closeModal('quiz-setup-modal');
    document.getElementById('quiz-play-modal').style.display = 'flex';
    nextQuizQuestion();
}

function nextQuizQuestion() {
    if(state.quizCurrentIdx >= state.quizData.length) {
        document.getElementById('quiz-play-body').innerHTML = `<h3>æ¸¬é©—çµæŸï¼</h3><p>å¾—åˆ†ï¼š${state.quizScore} / ${state.quizData.length}</p><button class="btn" onclick="closeModal('quiz-play-modal')">é—œé–‰</button>`;
        return;
    }

    const current = state.quizData[state.quizCurrentIdx];
    const types = Array.from(document.querySelectorAll('input[name="qType"]:checked')).map(c => c.value);
    const mode = types[Math.floor(Math.random() * types.length)];
    const isNLtoZH = Math.random() > 0.5;

    let html = `<h4>ç¬¬ ${state.quizCurrentIdx + 1} é¡Œ / å…± ${state.quizData.length} é¡Œ</h4>`;

    if(mode === 'mcq') {
        const question = isNLtoZH ? current.nl : current.zh;
        const answer = isNLtoZH ? current.zh : current.nl;
        let options = [answer];
        while(options.length < 4) {
            let rand = state.commonVocab[Math.floor(Math.random() * state.commonVocab.length)];
            let opt = isNLtoZH ? rand.zh : rand.nl;
            if(!options.includes(opt)) options.push(opt);
        }
        options.sort(() => Math.random() - 0.5);

        html += `<p>å•ï¼š<b>${question}</b> çš„æ„æ€æ˜¯ï¼Ÿ</p>`;
        options.forEach(opt => {
            html += `<button class="btn" style="display:block; width:100%; margin:5px 0; background:#eee; color:#333" onclick="checkAnswer('${opt}', '${answer}')">${opt}</button>`;
        });
    } else {
        const question = isNLtoZH ? current.nl : current.zh;
        const answer = isNLtoZH ? current.zh : current.nl;
        html += `<p>è«‹è¼¸å…¥ <b>${question}</b> çš„ç¿»è­¯ï¼š</p>`;
        html += `<input type="text" id="quiz-input" style="width:100%; padding:10px;"><br><br>`;
        html += `<button class="btn" onclick="checkAnswer(document.getElementById('quiz-input').value, '${answer}')">é€å‡º</button>`;
    }

    document.getElementById('quiz-play-body').innerHTML = html;
}

function checkAnswer(user, correct) {
    if(user.trim().toLowerCase() === correct.trim().toLowerCase()) {
        state.quizScore++;
        alert('æ­£ç¢ºï¼');
    } else {
        alert(`éŒ¯èª¤ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correct}`);
    }
    state.quizCurrentIdx++;
    nextQuizQuestion();
}

// é€šç”¨ Modal é—œé–‰
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function openItem(type, idx) {
    const data = state[type][idx];
    if(type === 'video') {
        let id = data.url.includes("v=") ? data.url.split("v=")[1].split("&")[0] : data.url.split("be/")[1];
        alert(`é–‹å•Ÿå½±ç‰‡æ’­æ”¾ï¼š${data.title}`);
        // é€™è£¡å¯ä»¥å°å‘å¦³åŸæœ¬çš„å½±ç‰‡æ’­æ”¾ä»‹é¢
    } else if(type === 'podcast') {
        window.open(data.link);
    }
}
</script>

</body>
</html>
